<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LHCb data flow in Run 3 &mdash; LHCb Starterkit Lessons  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels.css" type="text/css" />
      <link rel="stylesheet" href="../_static/starterkit.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/panels.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Asking good questions" href="asking-questions.html" />
    <link rel="prev" title="Developing LHCb Software" href="lhcb-dev.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> LHCb Starterkit Lessons
            <img src="../_static/starterkit.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="README.html">First Analysis Steps</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="prerequisites.html">Pre-workshop checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction-to-course.html">Goals of the course</a></li>
<li class="toctree-l2"><a class="reference internal" href="physics-at-lhcb.html">Physics at LHCb</a><ul>
<li class="toctree-l3"><a class="reference internal" href="physics-at-lhcb.html#the-reconstruction">The reconstruction</a></li>
<li class="toctree-l3"><a class="reference internal" href="physics-at-lhcb.html#building-decay-candidates">Building decay candidates</a></li>
<li class="toctree-l3"><a class="reference internal" href="physics-at-lhcb.html#building-more-complex-decays">Building more complex decays</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="dataflow.html">The LHCb data flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="run-2-data-flow.html">Changes to the data flow in Run 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="analysisflow.html">The analysis flow and analysis preservation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="analysisflow.html#getting-data-files">Getting data files</a></li>
<li class="toctree-l3"><a class="reference internal" href="analysisflow.html#useful-high-energy-physics-analysis-tools">Useful high energy physics analysis tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="analysisflow.html#analysis-preservation">Analysis Preservation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="davinci.html">An introduction to LHCb Software</a></li>
<li class="toctree-l2"><a class="reference internal" href="bookkeeping.html">Finding data in the Bookkeeping</a></li>
<li class="toctree-l2"><a class="reference internal" href="files-from-grid.html">Downloading a file from the grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="interactive-dst.html">Interactively exploring a DST</a></li>
<li class="toctree-l2"><a class="reference internal" href="minimal-dv-job.html">Running a minimal DaVinci job locally</a></li>
<li class="toctree-l2"><a class="reference internal" href="loki-functors.html">Fun with LoKi Functors</a></li>
<li class="toctree-l2"><a class="reference internal" href="add-tupletools.html">TupleTools and branches</a></li>
<li class="toctree-l2"><a class="reference internal" href="decay-tree-fitter.html">How do I use DecayTreeFitter?</a></li>
<li class="toctree-l2"><a class="reference internal" href="analysis-productions.html">Analysis Productions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="analysis-productions.html#monitoring-productions">Monitoring productions</a></li>
<li class="toctree-l3"><a class="reference internal" href="analysis-productions.html#creating-your-own-production">Creating your own production</a><ul>
<li class="toctree-l4"><a class="reference internal" href="analysis-productions.html#testing-your-production-locally">Testing your production locally</a></li>
<li class="toctree-l4"><a class="reference internal" href="analysis-productions.html#creating-a-merge-request">Creating a merge request</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="davinci-grid.html">Running DaVinci on the grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="split-jobs.html">Splitting a job into subjobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="ganga-data.html">More Ganga</a></li>
<li class="toctree-l2"><a class="reference internal" href="eos-storage.html">Storing large files on EOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="lhcb-dev.html">Developing LHCb Software</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">LHCb data flow in Run 3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lhcb-upgrade">LHCb upgrade</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upgrade-of-the-lhcb-trigger-system">Upgrade of the LHCb trigger system</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-hlt-architecture">The HLT architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#selective-persistency">Selective persistency</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#offline-data-processing">Offline data processing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#changes-to-davinci">Changes to DaVinci</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="asking-questions.html">Asking good questions</a></li>
<li class="toctree-l2"><a class="reference internal" href="ecgd.html">Early career, gender and diversity</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing-lesson.html">Contribute to this lesson</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../second-analysis-steps/README.html">Second Analysis Steps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/lb-git.html">Using git to develop LHCb software</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/building-decays.html">Building your own decay</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/building-decays-part0.html">The Selection Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/building-decays-part1.html">A Historical Approach</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/building-decays-part2.html">Modern Selection Framework</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/fixing-errors.html">What to do when something fails</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/rerun-stripping.html">Run a different stripping line on simulated data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/switch-mass-hypo.html">Replace a mass hypothesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/filter-in-trees.html">Reuse particles from a decay tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/simulation.html">The simulation framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-intro.html">What is Gauss?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-intro.html#choosing-your-gauss-version">Choosing your Gauss Version</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-running-gauss.html">Which option files to use and how to run Gauss</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-running-gauss.html#running-gauss-and-create-a-generator-only-sample">Running Gauss and create a generator-only sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-running-gauss.html#make-an-ntuple">Make an nTuple</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-dkfiles.html">Controlling the decay: DecFiles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-gencuts.html">Modifying the decay</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-gencuts.html#adding-a-decay-channel">Adding a decay channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-gencuts.html#generator-level-cuts">Generator level cuts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-gencuts.html#removing-the-generator-cuts">Removing the generator cuts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-gencuts.html#modifying-the-cut-tool">Modifying the cut tool</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html">Advanced: Modifying the decay</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html#multi-body-decays">3+ multi-body decays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html#cocktail-decays">Cocktail decays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html#final-state-radiation">Final state radiation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html#changing-particle-masses-lifetimes-widths">Changing particle masses / lifetimes/ widths</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html#finding-constants-used-in-an-existing-mc-sample-masses-lifetimes-etc">Finding Constants Used in an Existing MC Sample (Masses/Lifetimes/etc)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-fastsim.html">Why fast simulation is crucial</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-fastsim.html#speeding-up-the-detector-simulation">Speeding up the detector simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-fastsim.html#speeding-up-the-generation">Speeding up the generation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html">HLT intro</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html#add-trigger-information-to-your-ntuple">Add trigger information to your ntuple</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html#exploring-a-tck-list-of-trigger-lines">Exploring a TCK: List of trigger lines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html#add-trigger-information-to-your-ntuple-continued">Add trigger information to your ntuple, continued</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html#add-tistos-information-to-your-ntuple">Add TISTOS information to your ntuple</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html#exploring-a-tck-properties-of-trigger-lines">Exploring a TCK: Properties of trigger lines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/tistos-diy.html">TisTos DIY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/ganga-scripting.html">Scripting Ganga</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/ganga-scripting.html#defining-jobs-with-scripts">Defining jobs with scripts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/ganga-scripting.html#adding-helpers-functions">Adding helpers functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/managing-files-with-ganga.html">Managing files in Ganga</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/advanced-dirac.html">Advanced Dirac</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/advanced-dirac.html#gangatasks">GangaTasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/advanced-dirac.html#alternative-backends-dirac-python-bugged">Alternative Backends - DIRAC (Python bugged)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/advanced-dirac.html#alternative-backends-dirac-davinci">Alternative Backends - DIRAC (DaVinci)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/advanced-dirac.html#alternative-backends-condor">Alternative Backends - Condor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../self-guided-lessons/README.html">Self guided lessons</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../self-guided-lessons/htcondor.html">Batch submission using HTCondor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/htcondor-first-job.html">Submitting a simple job</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-first-job.html#tracking-your-jobs">Tracking your jobs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html">More submit file options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html#input-files">Input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html#output-files">Output files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html#arguments">Arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html#resources-and-requirements">Resources and Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html#notifications">Notifications</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/htcondor-queue.html">Using the queue command</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-queue.html#more-on-variables">More on variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-queue.html#other-ways-to-queue">Other ways to queue</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-queue.html#mixing-options-and-variables">Mixing options and variables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/htcondor.html#system-architecture">System architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/htcondor.html#other-useful-resources">Other useful resources</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html">Creating a grid proxy without LbScripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#installation">Installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#macos-with-homebrew">macOS with homebrew</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#ubuntu">Ubuntu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#centos">CentOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#arch-linux">Arch Linux</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#getting-the-required-files-and-certificates">Getting the required files and certificates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#creating-a-proxy">Creating a proxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#managing-the-proxy">Managing the proxy</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../CONTRIBUTING.html#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CONTRIBUTING.html#dependencies">Dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../CONDUCT.html">Contributor Code of Conduct</a></li>
<li class="toctree-l3"><a class="reference internal" href="../LICENSE.html">Instructional Material</a></li>
<li class="toctree-l3"><a class="reference internal" href="../LICENSE.html#software">Software</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">External links:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://hsf-training.github.io/analysis-essentials/">Analysis essentials</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cern.ch/lhcb-core-doc/">LHCb Core documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="https://lhcb.github.io/glossary/">LHCb glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">LHCb Starterkit Lessons</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="README.html">First Analysis Steps</a> &raquo;</li>
      <li>LHCb data flow in Run 3</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/lhcb/starterkit-lessons/blob/master/first-analysis-steps/dataflow-run3.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="lhcb-data-flow-in-run-3">
<h1>LHCb data flow in Run 3<a class="headerlink" href="#lhcb-data-flow-in-run-3" title="Permalink to this headline"></a></h1>
<div class="panel panel-objectives docutils container">
<div class="panel-header open docutils container">
<p id="learning-objectives"><i class="fa fa-line-chart"></i> Learning Objectives</p>
</div>
<div class="panel-body docutils container">
<ul class="simple">
<li><p>Understand the changes to the LHCb data flow for Run 3</p></li>
<li><p>Learn the key concepts on the HLT, Sprucing</p></li>
</ul>
</div>
</div>
<section id="lhcb-upgrade">
<h2>LHCb upgrade<a class="headerlink" href="#lhcb-upgrade" title="Permalink to this headline"></a></h2>
<p>In Run 1 &amp; 2 LHCb proved itself not only to be a high-precision
heavy flavour physics experiment, but also extended the core physics programme to many different areas such as electroweak physics and fixed-target experiments. This incredible precision led to
over 500 papers including breakthroughs such as the first discovery of $C!P$-violation in charm and the first observation of the decay $B_s^0\to \mu^+\mu^-$ among many others.</p>
<p>In order to reach even higher precision the experiment aims to take $50,\mathrm{fb}^{-1}$ of
data in Run 3 by increasing the instantaneous luminosity by a factor of five.
To be capable of dealing with the higher detector occupancy the experiment will be equipped with an entire new set of tracking detectors with higher granularity and improved radiation tolerance.</p>
<p>One of the most important upgrades in Run 3 will be the removal of the LHCb L0 hardware triggers. As described in the following, this will bring significant changes in the data flow of the experiment both for online and offline processing. It also means that the front-end and readout electronics of all sub-detectors will be replaced, to be able
to operate at the bunch crossing rate of $40,\mathrm{MHz}$, as well as the photodetectors of the RICH1 detector.</p>
</section>
<section id="upgrade-of-the-lhcb-trigger-system">
<h2>Upgrade of the LHCb trigger system<a class="headerlink" href="#upgrade-of-the-lhcb-trigger-system" title="Permalink to this headline"></a></h2>
<p>The trigger layout for Run 3 will look like this:</p>
<p><img alt="&quot;Data processing chain for Run 3&quot;" src="../_images/hidef_RTA_dataflow_widescreen.png" /></p>
<p>The LHCb trigger system will be fully redesigned by removing the L0 hardware trigger and moving to a fully-software based trigger. The hardware trigger has a rate limit of 1 MHz, which would be a limitation with the increase in luminosity. Such a low rate could be only achieved by having tight hardware trigger thresholds on $p_\mathrm{T}$ and $E_\mathrm{T}$ which is inefficient especially for fully hadronic decay modes. The removal of this bottleneck means that the full detector readout as well as running the HLT1 needs to be enabled at the average non-empty bunch crossing rate in LHCb of $30,\mathrm{MHz}$, a not so trivial computing challenge!</p>
<p>As we saw already at the <a class="reference external" href="https://lhcb.github.io/starterkit-lessons/first-analysis-steps/dataflow.html">Run 1 and Run 2 dataflow lecture</a>, the software trigger is implemented in two steps: the HLT1 which performs partial event reconstruction and simple trigger decisions to reduce the data rate, and HLT2, which performs the more computationally expensive full reconstruction and complete trigger selection. One of the most important tasks of building the events is track reconstruction, which is an inherently parallelizable process. For this purpose, HLT1 in Run 3 is implemented as part of the <code class="docutils literal notranslate"><span class="pre">Allen</span> <span class="pre">project</span></code> and run on GPUs.</p>
<section id="the-hlt-architecture">
<h3>The HLT architecture<a class="headerlink" href="#the-hlt-architecture" title="Permalink to this headline"></a></h3>
<p>Data from the various subdetectors are received in the central Data Acquisition (DAQ) system of LHCb by custom Field Programmable Gate Array (FPGA) cards, called PCIe40. A set of servers, the Event Builder (EB), then pieces together fragments of raw data information from the subdetectors to form events and group them into packets. The event packets are then passed to an Event Filtering Farm (EFF) for further processing, and events passing the selection end up in storage. The existing HLT architecture of LHCb is well suited for the requirements of GPUs and can be easily adapted to host them in the Event Builder. HLT1 will reduce the data rate by a factor of 30, and implementing it already at the EB level will greatly minimize the size of the network needed for the following steps.</p>
<p>Having the HLT1 run on GPUs imposes some different requirements on the code development. The <code class="docutils literal notranslate"><span class="pre">Allen</span></code> framework is based on the <code class="docutils literal notranslate"><span class="pre">CUDA</span></code> GPU programming platform. Developers should keep in mind that HLT1 algorithms should be implemented in a way that maximizes parallelizability and is thread-safe, i.e. memory should be accessed in a secure way from parallel processes. Documentation on how to develop reconstruction algorithms and selection lines for HLT1 can be found in the readme’s of the <a class="reference external" href="https://gitlab.cern.ch/lhcb/Allen">Allen project</a>.</p>
<p>The raw data of events selected by HLT1 is passed on to the buffer system and stored there. The buffering of events enables to run the real-time alignment and calibration before events are entering HLT2. This is crucial because in this way calibration and alignment constants obtained can be used in the full event reconstruction performed in HLT2. For the determination of these constants, HLT1 selects dedicated calibration samples.
More information about the real-time alignment and calibration can be found in the <a class="reference external" href="https://twiki.cern.ch/twiki/bin/view/LHCb/AlignmentInUpgrade">Upgrade Alignment TWIKI page</a>.</p>
<p>The total bandwidth that can be saved from HLT2 to tape is limited to $10,\mathrm{GB}/s$. An important change in the HLT2 selections with respect to the Run 2 will be the increased use of the Turbo model. Wherever possible, the Turbo will be the baseline, so that in total for approximately 2/3 of data only the data of the signal candidate (raw and reconstructed) will be saved and no further offline reconstruction will be possible. This results in significantly smaller event sizes so that more events can be saved.</p>
<p>For details and tutorials on how to develop HLT2 line selections as well as how to check their efficiencies and data rates follow the <a class="reference external" href="https://lhcbdoc.web.cern.ch/lhcbdoc/moore/master/index.html">Moore documentation</a>.</p>
</section>
<section id="selective-persistency">
<h3>Selective persistency<a class="headerlink" href="#selective-persistency" title="Permalink to this headline"></a></h3>
<p>Besides the events that are processed by the Turbo stream, there are cases for persisting extra information of the raw data. For some decay modes, it cannot be avoided to save the full raw data, whereas for others few extra information is needed. In case of persisting the full raw and reconstructed data of the event HLT2 line can be run by setting the flag <code class="docutils literal notranslate"><span class="pre">persistreco=True</span></code>. When full event information is not required objects can be persisted selectively by defining <code class="docutils literal notranslate"><span class="pre">extra_outputs</span></code>, which can be among the following:</p>
<ul class="simple">
<li><p>extra reconstructed tracks</p></li>
<li><p>ECAL clusters for neutral objects</p></li>
<li><p>…</p></li>
</ul>
</section>
</section>
<section id="offline-data-processing">
<h2>Offline data processing<a class="headerlink" href="#offline-data-processing" title="Permalink to this headline"></a></h2>
<p>Events that have passed HLT2 and have been saved to tape are further processed offline by running through the Sprucing application. After passing the Sprucing events are saved on disk. For events from the Turbo stream, the default model is to run through the Sprucing only in a passthrough sprucing selection, whereas others can undergo a tighter selection by running through a sprucing line. This is necessary because the total bandwidth for events that can be saved on disk is only 3.6GB/s, whereas for saving data from HLT2 to tape 10GB/s are available. Data that is saved to disk will be provided in streams dedicated to specific physics applications.</p>
<p>HLT2 and sprucing selections share the same code base, so that selection lines can be interchanged among the two flexibly.</p>
<p><img alt="https://lhcbproject.web.cern.ch/lhcbproject/Publications/f/p/Directory_LHCb-FIGURE-2020-016/hidef_DPA_dataflow.png" src="https://lhcbproject.web.cern.ch/lhcbproject/Publications/f/p/Directory_LHCb-FIGURE-2020-016/hidef_DPA_dataflow.png" /></p>
<section id="changes-to-davinci">
<h3>Changes to DaVinci<a class="headerlink" href="#changes-to-davinci" title="Permalink to this headline"></a></h3>
<p>As in Run 2, the DaVinci application is used to produce tuples for offline user analysis from the different physics streams. DaVinci itself is being redesigned to address the following issues:</p>
<ul class="simple">
<li><p>storage and computing resources are limited and saving irrelevant variables should be avoided, especially because there will be much more data in Run 3</p></li>
<li><p>consistency between online and offline selection frameworks in using ThOr functors</p></li>
</ul>
<p>For this purpose the tupling tool is changed to <code class="docutils literal notranslate"><span class="pre">FunTuple</span></code> which allows more flexibility for users to choose only variables that are needed for the analysis and not take all variables from a specific TupleTool. After a transition certain period that is necessary to develop all demanded tupling features for <code class="docutils literal notranslate"><span class="pre">FunTuple</span></code> the TupleTools used in Run 2 will no longer be supported and fully removed from DaVinci.
At the moment FunTuple supports both LoKi and ThOr functors until all relevant functors are migrated to the ThOr framework. Afterwards the use of LoKi functors will be depricated.</p>
<p>For detailed information and implementation examples of <code class="docutils literal notranslate"><span class="pre">FunTuple</span></code> and offline data processing in Run 3 see the <a class="reference external" href="https://gitlab.cern.ch/lhcb/DaVinci/-/blob/master/DaVinciExamples/python/DaVinciExamples/tupling/example-tupling-advanced-run-mc.py">DaVinciExamples</a> and <a class="reference external" href="https://lhcb-dpa.web.cern.ch/lhcb-dpa/index.html">DPA documentation</a>.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="lhcb-dev.html" class="btn btn-neutral float-left" title="Developing LHCb Software" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="asking-questions.html" class="btn btn-neutral float-right" title="Asking good questions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015-2020, LHCb Starterkit.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>